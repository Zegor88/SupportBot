title: "[Epic]: E2 Validator"

## Описание эпика
Реализация ValidatorAgent, который фильтрует сообщения не на английском языке, отвечая стандартной заглушкой при обнаружении нарушений. Первоначальная реализация фокусируется на валидации языка с помощью промпт-инжиниринга в рамках OpenAI Agents SDK.

### Задачи

**1. [Task E2.1 (revised)] Агент Валидации Языка с Промпт-Инжинирингом**
   - **Описание:** Создать `LanguageValidatorAgent` (используя OpenAI Agents SDK), который с помощью специально разработанного промпта определяет, написано ли входящее сообщение на английском языке. Если язык не английский, агент должен подготовить информацию для стандартизированного ответа.
   - **Подзадачи:**
     - [x] Изучить документацию OpenAI Agents SDK ([Quickstart](https://openai.github.io/openai-agents-python/quickstart/), [Agents](https://openai.github.io/openai-agents-python/agents/), [Guardrails](https://openai.github.io/openai-agents-python/guardrails/)) для выбора оптимальной реализации (Agent или Guardrail).
     - [x] Разработать промпт для агента, который инструктирует его:
         - Определить язык входящего текста.
         - Если язык не английский, определить название этого языка (например, "Spanish", "French", "Russian").
         - Вернуть структурированный вывод, например, Pydantic модель: `class LanguageValidationResult(BaseModel): is_english: bool; detected_language: Optional[str] = None`.
     - [x] Реализовать `LanguageValidatorAgent` с этим промптом, настроив его на возврат указанной структуры данных (используя `output_type` в SDK).
     - [x] Протестировать агента с различными языками для проверки корректности определения и структурированного вывода.
   - **Критерии приемки:**
     - [x] Агент корректно идентифицирует не-английские сообщения, используя промпт.
     - [x] Агент возвращает структурированный результат, указывающий, является ли язык английским, и название обнаруженного языка (если не английский).
     - [x] Английские сообщения корректно идентифицируются как таковые.
   - **Зависимости:** E1 (Telegram Handler), OpenAI API Key для SDK.
   - **Оценка времени:** ~6-10 часов.

**2. [Task E2.2 (revised)] Интеграция Языкового Валидатора и Отправка Заглушки**
   - **Описание:** Встроить `LanguageValidatorAgent` в основной поток обработки сообщений Telegram-бота. Если агент определяет, что язык не английский, бот должен отправить стандартизированный ответ.
   - **Подзадачи:**
     - [x] Модифицировать существующую логику `TelegramBot` (вероятно, в `src/bot/handlers.py` или через новый слой обработки перед текущими хендлерами) для вызова `LanguageValidatorAgent` (или его `Runner`) с входящим текстом сообщения.
     - [x] Получить структурированный результат от `LanguageValidatorAgent`.
     - [x] Если результат указывает, что язык не английский (`is_english == False`):
         - Сформировать ответ: "This chat is for English language communication. You texted me in <Detected Language>. Please rephrase your question in English." (используя `detected_language` из результата агента).
         - Отправить этот ответ пользователю через Telegram.
         - Прекратить дальнейшую обработку сообщения (т.е. не вызывать `echo` или другие будущие обработчики).
     - [x] Если результат указывает, что язык английский (`is_english == True`), сообщение передается на следующий этап обработки (например, текущий `echo`).
   - **Критерии приемки:**
     - [x] Сообщения не на английском языке получают от бота корректный стандартизированный ответ с указанием обнаруженного языка.
     - [x] Сообщения на английском языке обрабатываются ботом как и раньше (например, `echo` ответ).
     - [x] Логика интеграции четко определена и не нарушает существующую функциональность для английских сообщений.
   - **Зависимости:** Task E2.1 (revised).
   - **Оценка времени:** ~3-5 часов.

**(Отложено) [Task E2.3] Детекция Токсичности и Спама**
   - Описание: Будет добавлено в будущем.

**(Отложено) [Task E2.4] Настройка Ответов-Заглушек**
   - Описание: Базовая заглушка для языка будет реализована в E2.2. Расширенная конфигурация будет рассмотрена позже.

### Общие Технические Заметки для Эпика E2 (текущий фокус):
- **Основной фреймворк:** OpenAI Agents SDK.
- **Определение языка:** Промпт-инжиниринг с LLM агента.
- **Структура Агента:** `LanguageValidatorAgent` (вероятно, один `Agent` или `Guardrail` из SDK).

### Приоритеты согласно PRD и последним уточнениям:
1.  Language Constraint (Task E2.1 revised, Task E2.2 revised). 